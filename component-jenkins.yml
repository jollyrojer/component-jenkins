application:
  configuration:
    input.image: "us-east-1/ami-59a4a230"
    input.image-user: "ubuntu"
    input.instance-size: "m1.small"
    input.recipe-url: "https://dl.dropboxusercontent.com/u/250836/jenkins.tar.gz"

  interfaces:
    input:
      image: "bind(jenkins#input.image)"
      image-user: "bind(jenkins#input.image-user)"
      instance-size: "bind(jenkins#input.instance-size)"
      recipe-url: "bind(jenkins#input.recipe-url)"
    output:
      jenkins-server-host: "bind(jenkins#result.jenkins-server-host)"
      jenkins-slave-host: "bind(jenkins#result.jenkins-slave-host)"
      jenkins-url: "bind(jenkins#result.jenkins-server-url)"
      jenkins-admin-password: "bind(jenkins#result.jenkins-admin-password)"

  components:
    jenkins:
      type: workflow.Instance
      interfaces:
        input:
          image: configuration(string)
          instance-size: configuration(string)
          image-user: configuration(string)
          recipe-url: configuration(string)
        result:
          jenkins-server-host: publish-signal(string)
          jenkins-slave-host: publish-signal(string)
          jenkins-server-url: publish-signal(string)
          jenkins-admin-password: publish-signal(list<string>)

      configuration:
        configuration.workflows:
          launch:
            parameters:
              - image:
                  description: AMI id
              - image-user:
                  description: AMI ssh user
              - instance-size:
                  description: Instance type
              - recipe-url:
                  description: Recipe URL
            steps:
              - launch-server:
                  action: provisionVms
                  parameters:
                    hardwareId: "{$.instance-size}"
                    imageId: "{$.image}"
                    vmIdentity: "{$.image-user}"
                    roleName: server
                  output:
                    jenkins-server-hosts: ips

              - launch-slave:
                  action: provisionVms
                  parameters:
                    hardwareId: "{$.instance-size}"
                    imageId: "{$.image}"
                    vmIdentity: "{$.image-user}"
                    roleName: slave
                  output:
                    jenkins-slave-hosts: ips

              - install-jenkins-server:
                  action: chefsolo
                  precedingPhases: [launch-server]
                  parameters:
                    recipeUrl: "{$.recipe-url}"
                    runList: [ "recipe[cookbook_qubell_jenkins::default]" ]
                    roles: [ server ]
                    jattrs:
                      jenkins:
                        server:
                          host: "{$.jenkins-server-hosts[0]}"
                  output:
                    server-attrs: chefState

              - install-jenkins-slave:
                  action: chefsolo
                  precedingPhases: [install-jenkins-server,launch-slave]
                  parameters:
                    recipeUrl: "{$.recipe-url}"
                    runList: [ "recipe[cookbook_qubell_jenkins::node]" ]
                    roles: [ slave ]
                    jattrs:
                      jenkins:
                        server:
                          url: "http://{$.jenkins-server-hosts[0]}:8080"
                        cli:
                          username: "admin"
                          password: "{$.server-attrs['*'].jenkins.server.admin_password[0]}"
                  output:
                    slave-attrs: chefState

            return:
              jenkins-server-host:
                value: "{$.jenkins-server-hosts[0]}"
              jenkins-slave-host:
                value: "{$.jenkins-slave-hosts[0]}"
              jenkins-server-url:
                value: "http://{$.jenkins-server-hosts[0]}:8080"
              jenkins-admin-password:
                value: "{$.server-attrs['*'].jenkins.server.admin_password}"
